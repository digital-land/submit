{% macro endpointErrorMessage(endpoint) %}
  {% if endpoint.error.code %}
    There was a {{ endpoint.error.code }} error accessing the endpoint URL
  {% else %}
    There was an error accessing the endpoint URL
  {% endif %}
{% endmacro %}

{% macro datasetUrl(organisation, dataset, endpoint) %}
  /organisations/{{ organisation.organisation | urlencode }}/{{ dataset.dataset | urlencode }}/endpoint-error/{{ endpoint.endpoint | urlencode }}
{% endmacro %}

{% macro lastAccessedInfo(organisation, dataset, endpoint) %}
  {{endpoint.lastAccessed | govukDateTime}}
  <br>
  <p class="govuk-error-message">
    <a href="{{ datasetUrl(organisation, dataset, endpoint) }}">{{ endpointErrorMessage(endpoint) }}</a>
  </p>
  <p class="app-inset-text__error"></p>
{% endmacro %}

{% from "govuk/components/breadcrumbs/macro.njk" import govukBreadcrumbs %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "../components/dataset-navigation.html" import datasetNavigation %}
{% from "components/deadlineNotice.html" import deadlineNotice %}
{% from "components/alternativeSourceNotice.html" import alternativeSourceNotice %}

{% set navigationItems = currentPath | getNavigationLinks(['organisations', 'guidance']) %}

{% set serviceType = 'Manage' %}
{% set pageName %}
    {{organisation.name}} - {{dataset.dataset | datasetSlugToReadableName(true)}} - Dataset overview
{% endset %}
{% set urlStyle = 'text-overflow: ellipsis; overflow: hidden; white-space: nowrap; width: 400px; display: block;' %}

{% extends "layouts/main.html" %}



{% block beforeContent %}

{{ super() }}

{{ govukBreadcrumbs({
  items: [
    {
      text: "Home",
      href: "/"
    },
    {
      text: "Organisations",
      href: '/organisations'
    },
    {
      text: organisation.name,
      href: '/organisations/' + organisation.organisation
    },
    {
      text: dataset.dataset | datasetSlugToReadableName(true)
    }
  ]
}) }}

{% endblock %}

{% set rows = [
  {
    key: {
      text: "Number of records"
    },
    value: {
      text: stats.numberOfRecords | default(0)
    }
  }
] %}

{% if alternateSources and alternateSources | length > 0 %}
  {% if alternateSources | length == 1 %}
    {% set alternateSourcesRow = {
      key: {
        text: "Alternative source"
      },
      value: {
        text: alternateSources[0].name
      }
    } %}
  {% else %}
    {% set sourcesList %}
      <ul class="govuk-list govuk-list--bullet">
        {% for source in alternateSources %}
          <li>{{ source.name }}</li>
        {% endfor %}
      </ul>
    {% endset %}
    {% set alternateSourcesRow = {
      key: {
        text: "Alternative sources"
      },
      value: {
        html: sourcesList
      }
    } %}
  {% endif %}
  {% set _ = rows.push(alternateSourcesRow) %}
{% endif %}

{% if authority !== 'some' %}
  {% set licenceRow = {
    key: {
      text: "Licence"
    },
    value: {
      text: "Open Government Licence"
    }
  } %}
  {{ rows.push(licenceRow) }}

  {% for endpoint in stats.endpoints %}
    {% set endpointRow = {
      key: {
        text: 'Endpoint URL',
        classes: 'padding-top'
      },
      value: {
        html: '<a  style="'+urlStyle+'" href="'+endpoint.endpoint_url+'">'+endpoint.endpoint_url+'</a>'
      },
      classes: 'padding-top'
    } %}
    {{ rows.push(endpointRow) }}

    {% if endpoint.documentation_url %}
      {% set documentationRow = {
        key: {
          text: 'Documentation URL'
        },
        value: {
          html: '<a style="'+urlStyle+'" href="'+endpoint.documentation_url+'">'+endpoint.documentation_url+'</a>'
        }
      } %}
      {{ rows.push(documentationRow) }}
    {% endif %}

    {% if endpoint.error %}
      {% set lastAccessedRow = {
        key: {
          text: 'Endpoint URL last accessed',
          classes: 'app-inset-text---error'
        },
        value: {
          html: lastAccessedInfo(organisation, dataset, endpoint)
        }
      } %}
    {% else %}
      {% set lastAccessedRow = {
        key: {
          text: 'Endpoint URL last accessed'
        },
        value: {
          text: endpoint.lastAccessed | govukDateTime
        }
      } %}
    {% endif %}


    {{ rows.push(lastAccessedRow) }}

    {% set lastUpdatedRow = {
      key: {
        text: 'Endpoint URL last updated'
      },
      value: {
        text: endpoint.lastUpdated and ( endpoint.lastUpdated | govukDateTime )
      }
    } %}
    {{ rows.push(lastUpdatedRow) }}

    {% set entryDateRow = {
      key: {
        text: 'Endpoint entry date'
      },
      value: {
        text: endpoint.entryDate and ( endpoint.entryDate | govukDateTime )
      }
    } %}
    {{ rows.push(entryDateRow) }}

  {% endfor %}
{% endif %}

{% block content %}

<div class="govuk-grid-row">
    {% include "includes/_dataset-page-header.html" %}
</div>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    {{ datasetNavigation({
      active: "dataset-overview",
      dataset: dataset,
      organisation: organisation,
      task_count: taskCount
    }) }}
    {% if showMap %}
      <section>
        <h2 class="govuk-heading-m govuk-visually-hidden">Map of dataset</h2>
        <div id="map" class="app-map" role="region" aria-label="Map illustrating {{ dataset.name }} geometries. Use your keyboard to interact with the map. For screen reader users, use the arrow keys to navigate the map and the plus and minus keys to zoom in and out."></div>
      </section>
    {% endif %}
  </div>
</div>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    <section>
      <h2 class="govuk-heading-m">Dataset details</h2>
      {{ govukSummaryList({ rows: rows }) }}
    </section>
    {% if authority === "some" %}
      {{ alternativeSourceNotice(organisation, dataset, downloadUrl, alternateSources) }}
    {% endif %}
  </div>
  <div class="govuk-grid-column-one-third">
    <section>
      <h2 class="govuk-heading-m">Dataset actions</h2>
      <ul class="govuk-list">
        <li>
          <a class="govuk-link" href="/organisations/{{ organisation.organisation }}/{{ dataset.dataset }}/get-started">How to prepare and provide your {{ dataset.dataset | datasetSlugToReadableName }} data</a>
        </li>
        <li>
          <a class="govuk-link" href="{{ organisation | checkToolDeepLink(dataset) }}">Check {{ dataset.dataset | datasetSlugToReadableName }} dataset</a>
        </li>
        {% if dataset.dataset | getDatasetGuidanceUrl %}
        <li>
          <a class="govuk-link" href="{{ dataset.dataset | getDatasetGuidanceUrl }}">{{ dataset.name }} guidance</a>
        </li>
        {% else %}
        <li>
          <a class="govuk-link" href="{{ "default" | getDatasetGuidanceUrl }}">Explore our dataset upload guidance</a>
        </li>
        {% endif %}
        {#
        <li>
          <a class="govuk-link" href="{{downloadUrl}}">Download this data</a>
        </li>
        #}
      </ul>
    </section>
  </div>
</div>

{% endblock %}

{% block scripts %}
  {{ super() }}
  {% if showMap %}
    <script>
      window.serverContext = {
        containerId: 'map',
        geoJsonUrl: "https://www.planning.data.gov.uk/entity.geojson?dataset={{ dataset.dataset }}&geometry_curie=statistical-geography:{{ organisation.statistical_geography }}&limit=500{% if authority === "some" or authority === "authoritative" %}&quality={{ authority }}{% endif %}",
        boundaryGeoJsonUrl: "/api/lpa-boundary/{{ organisation.organisation | urlencode }}",
        authority: "{{ authority }}"
      }
    </script>
    <script src="/public/js/map.bundle.js"></script>
  {% endif %}
{% endblock %}
