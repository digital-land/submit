<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: utils/utils.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: utils/utils.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>export const severityLevels = {
  notice: 'notice',
  informational: 'info',
  warning: 'warning',
  error: 'error'
}

export const dataSubjects = {
  'article-4-direction': {
    available: true,
    dataSets: [
      {
        value: 'article-4-direction',
        text: 'Article 4 direction',
        available: true
      },
      {
        value: 'article-4-direction-area',
        text: 'Article 4 direction area',
        available: true
      }
    ]
  },
  'brownfield-land': {
    available: true,
    dataSets: [
      {
        value: 'brownfield-land',
        text: 'Brownfield land',
        available: true
      },
      {
        value: 'brownfield-site',
        text: 'Brownfield site',
        available: false
      }
    ]
  },
  'conservation-area': {
    available: true,
    dataSets: [
      {
        value: 'conservation-area',
        text: 'Conservation area',
        available: true
      },
      {
        value: 'conservation-area-document',
        text: 'Conservation area document',
        available: true
      }
    ]
  },
  'listed-building': {
    available: true,
    dataSets: [
      {
        value: 'listed-building',
        text: 'Listed building',
        available: false
      },
      {
        value: 'listed-building-grade',
        text: 'Listed building grade',
        available: false
      },
      {
        value: 'listed-building-outline',
        text: 'Listed building outline',
        available: true
      }
    ]
  },
  'tree-preservation-order': {
    available: true,
    dataSets: [
      {
        value: 'tree',
        text: 'Tree',
        available: true,
        requiresGeometryTypeSelection: true
      },
      {
        value: 'tree-preservation-order',
        text: 'Tree preservation order',
        available: true
      },
      {
        value: 'tree-preservation-zone',
        text: 'Tree preservation zone',
        available: true
      }
    ]
  }
}

export const entryIssueGroups = [
  {
    type: 'missing value',
    field: 'reference'
  },
  {
    type: 'reference values are not unique',
    field: 'reference'
  },
  {
    type: 'unknown entity - missing reference',
    field: 'entity'
  }
]

export function makeDatasetsLookup (dataSubjects) {
  const lookup = new Map()
  for (const [key, dataSubject] of Object.entries(dataSubjects)) {
    for (const dataSet of dataSubject.dataSets) {
      lookup.set(dataSet.value, { ...dataSet, dataSubject: key })
    }
  }

  return lookup
}

/**
 * @typedef {Object} Dataset
 * @property {string} value - Dataset value/identifier
 * @property {string} text - Display text for the dataset
 * @property {boolean} available - Whether the dataset is available
 * @property {string} dataSubject - The data subject this dataset belongs to
 * @property {boolean} [requiresGeometryTypeSelection] - Whether geometry type selection is required
 */

/**
 * Map of dataset identifiers to their configuration objects
 * @type {Map&lt;string, Dataset>}
 */
export const datasets = makeDatasetsLookup(dataSubjects)

/**
 * Gets the list of available datasets sorted by display text
 *
 * @param {Object} dataSubjects - Data subjects configuration object
 * @returns {Dataset[]} Array of available datasets sorted by text property
 */
export function availableDatasets (dataSubjects) {
  const availableDataSubjects = Object.values(dataSubjects).filter(dataSubject => dataSubject.available)
  const dataSets = Object.values(availableDataSubjects).map(dataSubject => dataSubject.dataSets).flat()
  const availableDatasets = dataSets.filter(dataSet => dataSet.available)
  availableDatasets.sort((a, b) => a.text.localeCompare(b.text))
  return availableDatasets
}

export const finishedProcessingStatuses = [
  'COMPLETE',
  'FAILED'
]

export const allowedFileTypes = {
  csv: ['text/csv', 'text/plain', 'application/octet-stream', 'binary/octet-stream'],
  xls: ['application/vnd.ms-excel', 'application/octet-stream', 'binary/octet-stream'],
  xlsx: ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/octet-stream', 'binary/octet-stream'],
  xml: ['application/xml', 'text/xml'],
  json: ['application/json', 'application/octet-stream', 'binary/octet-stream'],
  geojson: ['application/vnd.geo+json', 'application/octet-stream', 'binary/octet-stream', 'application/geo+json'],
  gml: ['application/gml+xml', 'application/octet-stream', 'binary/octet-stream'],
  gpkg: ['application/gpkg', 'application/octet-stream', 'binary/octet-stream'],
  sqlite: ['application/geopackage+sqlite3', 'application/octet-stream', 'binary/octet-stream'],
  zip: ['application/zip', 'application/octet-stream', 'binary/octet-stream']

}

/**
 * @typedef {Object} RequiredDataset
 * @property {string} dataset - The dataset identifier
 * @property {string} deadline - The deadline pattern in ISO format with YYYY placeholder
 * @property {number} noticePeriod - Number of months before deadline to show notice
 */

/** @type {RequiredDataset[]} */
export const requiredDatasets = [
  {
    dataset: 'brownfield-land',
    deadline: 'YYYY-12-31T23:59:59.000Z',
    noticePeriod: 4 // months
  }
]

/**
 * Calculates the deadline date and its historical dates (last year's deadline, two years ago's deadline)
 * based on the provided deadline string.
 *
 * @param {string} deadline - The deadline date string in the format 'YYYY-MM-DDTHH:MM:SSZ'
 * @returns {object} An object containing the calculated deadline dates:
 *   - deadlineDate: The calculated deadline date
 *   - lastYearDeadline: The deadline date one year ago from the calculated deadline date
 *   - twoYearsAgoDeadline: The deadline date two years ago from the calculated deadline date
 *
 * @example
 * const deadline = 'XXXX-03-15T14:30:00Z';
 * const deadlines = getDeadlineHistory(deadline);
 * console.log(deadlines);
 * // Output:
 * // {
 * //   deadlineDate: &lt;Date>,
 * //   lastYearDeadline: &lt;Date>,
 * //   twoYearsAgoDeadline: &lt;Date>
 * // }
 */
export const getDeadlineHistory = (deadline) => {
  const deadlineRegex = /^.{4}-(?:0[1-9]|1[0-2])-(?:0[1-9]|[12]\d|3[01])T(?:[01]\d|2[0-3]):[0-5]\d:[0-5]\d(?:\.\d{1,3})?Z$/

  if (!deadlineRegex.test(deadline)) {
    throw new Error(`Invalid deadline format. Expected 'YYYY-MM-DDTHH:MM:SSSZ', got '${deadline}'`)
  }

  const deadlineParts = deadline.split(/[-T:.Z]/)
  const currentDate = new Date()

  const deadlineDate = new Date(
    currentDate.getFullYear(), // year
    parseInt(deadlineParts[1], 10) - 1, // month (0-based)
    deadlineParts[2], // day
    deadlineParts[3], // hour
    deadlineParts[4], // minute
    deadlineParts[5] // second
  )

  const isDeadlineThisYear = deadlineDate &lt;= currentDate

  if (isDeadlineThisYear) {
    deadlineDate.setFullYear(currentDate.getFullYear() + 1)
  }

  const lastYearDeadline = new Date(deadlineDate.getTime())
  lastYearDeadline.setFullYear(deadlineDate.getFullYear() - 1)

  const twoYearsAgoDeadline = new Date(lastYearDeadline.getTime())
  twoYearsAgoDeadline.setFullYear(lastYearDeadline.getFullYear() - 1)

  return {
    deadlineDate,
    lastYearDeadline,
    twoYearsAgoDeadline
  }
}

export const issueErrorMessageHtml = (errorMessage, issue) =>
  `${issue &amp;&amp; issue.value ? issue.value : (issue &amp;&amp; issue.length ? issue : '')}&lt;p class="govuk-error-message">${errorMessage}&lt;/p>`
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="CheckDeepLinkController.html">CheckDeepLinkController</a></li><li><a href="EndpointSubmissionFormDeepLinkController.html">EndpointSubmissionFormDeepLinkController</a></li><li><a href="MiddlewareError.html">MiddlewareError</a></li><li><a href="PageController.html">PageController</a></li><li><a href="module.html#.exports">exports</a></li></ul><h3>Global</h3><ul><li><a href="global.html#FetchOneFallbackPolicy">FetchOneFallbackPolicy</a></li><li><a href="global.html#addNoticesToDatasets">addNoticesToDatasets</a></li><li><a href="global.html#attachFileToIssue">attachFileToIssue</a></li><li><a href="global.html#availableDatasets">availableDatasets</a></li><li><a href="global.html#checkToolDeepLink">checkToolDeepLink</a></li><li><a href="global.html#createCustomerRequest">createCustomerRequest</a></li><li><a href="global.html#datasetStatusEnum">datasetStatusEnum</a></li><li><a href="global.html#datasetSubmissionDeadlineCheck">datasetSubmissionDeadlineCheck</a></li><li><a href="global.html#datasets">datasets</a></li><li><a href="global.html#endpointSubmissionFormToolDeepLink">endpointSubmissionFormToolDeepLink</a></li><li><a href="global.html#fetchDatasetErrorStatus">fetchDatasetErrorStatus</a></li><li><a href="global.html#fetchIf">fetchIf</a></li><li><a href="global.html#fetchIfFn">fetchIfFn</a></li><li><a href="global.html#fetchLatestResource">fetchLatestResource</a></li><li><a href="global.html#fetchLocalAuthorities">fetchLocalAuthorities</a></li><li><a href="global.html#fetchMany">fetchMany</a></li><li><a href="global.html#fetchManyFn">fetchManyFn</a></li><li><a href="global.html#fetchManyFromAllDatasets">fetchManyFromAllDatasets</a></li><li><a href="global.html#fetchManyFromAllDatasetsFn">fetchManyFromAllDatasetsFn</a></li><li><a href="global.html#fetchOne">fetchOne</a></li><li><a href="global.html#fetchOneFn">fetchOneFn</a></li><li><a href="global.html#fetchOneFromAllDatasets">fetchOneFromAllDatasets</a></li><li><a href="global.html#fetchResourceStatus">fetchResourceStatus</a></li><li><a href="global.html#formatData">formatData</a></li><li><a href="global.html#getColumnFieldLog">getColumnFieldLog</a></li><li><a href="global.html#getDeadlineHistory">getDeadlineHistory</a></li><li><a href="global.html#getErrorSummary">getErrorSummary</a></li><li><a href="global.html#getGeometries">getGeometries</a></li><li><a href="global.html#getIssueDetails">getIssueDetails</a></li><li><a href="global.html#getIssueField">getIssueField</a></li><li><a href="global.html#getLastPage">getLastPage</a></li><li><a href="global.html#getPagination">getPagination</a></li><li><a href="global.html#getRowsWithVerboseColumns">getRowsWithVerboseColumns</a></li><li><a href="global.html#getSetDataRange">getSetDataRange</a></li><li><a href="global.html#getStatusTag">getStatusTag</a></li><li><a href="global.html#getVerboseColumns">getVerboseColumns</a></li><li><a href="global.html#handleRejections">handleRejections</a></li><li><a href="global.html#initiateJsHiddenChecks">initiateJsHiddenChecks</a></li><li><a href="global.html#invalidSchemaPaths">invalidSchemaPaths</a></li><li><a href="global.html#isFeatureEnabled">isFeatureEnabled</a></li><li><a href="global.html#isResourceIdValid">isResourceIdValid</a></li><li><a href="global.html#logPageError">logPageError</a></li><li><a href="global.html#lpaOverviewQuery">lpaOverviewQuery</a></li><li><a href="global.html#makeDatasetSlugToReadableNameFilter">makeDatasetSlugToReadableNameFilter</a></li><li><a href="global.html#maybeSetReferrer">maybeSetReferrer</a></li><li><a href="global.html#orgStatsReducer">orgStatsReducer</a></li><li><a href="global.html#pagination">pagination</a></li><li><a href="global.html#parallel">parallel</a></li><li><a href="global.html#parallelFn">parallelFn</a></li><li><a href="global.html#postRequest">postRequest</a></li><li><a href="global.html#prepareDatasetEndpointIssueTemplateParams">prepareDatasetEndpointIssueTemplateParams</a></li><li><a href="global.html#prepareDatasetOverviewTemplateParams">prepareDatasetOverviewTemplateParams</a></li><li><a href="global.html#prepareDatasetTaskListTemplateParams">prepareDatasetTaskListTemplateParams</a></li><li><a href="global.html#prepareGetOrganisationsTemplateParams">prepareGetOrganisationsTemplateParams</a></li><li><a href="global.html#prepareOverviewTemplateParams">prepareOverviewTemplateParams</a></li><li><a href="global.html#prepareTasks">prepareTasks</a></li><li><a href="global.html#preventIndexing">preventIndexing</a></li><li><a href="global.html#processEntitiesMiddleware">processEntitiesMiddleware</a></li><li><a href="global.html#processSpecificationMiddleware">processSpecificationMiddleware</a></li><li><a href="global.html#proto">proto</a></li><li><a href="global.html#render">render</a></li><li><a href="global.html#renderTemplate">renderTemplate</a></li><li><a href="global.html#renderTemplateFn">renderTemplateFn</a></li><li><a href="global.html#requiredDatasets">requiredDatasets</a></li><li><a href="global.html#requiresGeometryTypeToBeSelected">requiresGeometryTypeToBeSelected</a></li><li><a href="global.html#requiresGeometryTypeToBeSelectedViaDeepLink">requiresGeometryTypeToBeSelectedViaDeepLink</a></li><li><a href="global.html#schemaIssues">schemaIssues</a></li><li><a href="global.html#setNoticesFromSourceKey">setNoticesFromSourceKey</a></li><li><a href="global.html#setupNunjucks">setupNunjucks</a></li><li><a href="global.html#splitByLeading">splitByLeading</a></li><li><a href="global.html#statusToTagClassMapping">statusToTagClassMapping</a></li><li><a href="global.html#templateSchema">templateSchema</a></li><li><a href="global.html#types">types</a></li><li><a href="global.html#validateAndRender">validateAndRender</a></li><li><a href="global.html#validateQueryParamsFn">validateQueryParamsFn</a></li><li><a href="global.html#validationErrorMessage">validationErrorMessage</a></li><li><a href="global.html#wizardBackLink">wizardBackLink</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
